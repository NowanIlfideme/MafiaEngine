from mafia_engine.base import GameObject, Action, Y, AbilityError

from ruamel.yaml import YAML, yaml_object

@yaml_object(Y)
class AbilityRestriction(GameObject): # TODO: DEPRECATED Remove.
    """Represents a callable "restriction" object, used to check
    whether an ability is legal to use."""

    yaml_tag = u"!AbilityRestriction"

    def __init__(self,  **kwargs):
        """
        Keys: name
        """
        super().__init__(**kwargs)
        pass

    def __call__(self, abil, **kwargs):
        """Override this! Return True if you allow. 
        In case of argument error, Raise AbilityError.
        Make sure to call the super's method."""

        #super().__call__(abil, **kwargs) #ONLY for descendants
        if not isinstance(abil, Ability):
            raise AbilityError("Wrong type. 'abil' should be 'self'. \
Exptected Ability, recieved " + str(abil.__class__.__name__))
        return True

    pass


@yaml_object(Y)
class Ability(GameObject):
    """Denotes an ability, which can be used as an Action.
    This is a base type for Activated and Automatic abilities
    (akin to Magic: The Gathering's system). """

    def __init__(self, name="", **kwargs):
        """
        Keys: name
        """
        super().__init__(name=name, **kwargs)
        #TODO: Add data memebers

        pass
    
    @property
    def action_type(self):
        """Gets the type of Action generated by this Ability.
        Override this!"""
        return Action

    def repr_map(self):
        """Map to use as representation (to create your self).
        Override or extend this for each child!"""

        res = super().repr_map()
        res.update( { 
            } )
        return res

    pass

@yaml_object(Y)
class ActivatedAbility(Ability):
    """Ability that gets activated by an Entity.
    This (usually) generates an Action and Event when used."""

    def __init__(self, restrictions=[], **kwargs):
        super().__init__(**kwargs)
        self.restrictions = restrictions
        pass
    
    def action(self, **kwargs):
        act = self.action_type(engine=self.engine)

        for r in self.restrictions:
            try:
                if not r(self, **kwargs): 
                    #If we fail even one restriction, we must return
                    raise AbilityError("Abilitiy failed due to restriction: %s." % r) #For debuggingg
                    return #TODO: Add return value from actions?
            except AbilityError as e:
                raise #for debugging; in real life, you'd want to return       
        act(**kwargs)
        pass
    
    def repr_map(self):
        """Map to use as representation (to create your self).
        Override or extend this for each child!"""

        res = super().repr_map()
        res.update( { 
            "restrictions":self.restrictions,
            } )
        return res

    pass

@yaml_object(Y)
class AutomaticAbility(Ability):
    """Ability that triggers from an Event.
    This might generate a new Action + Event."""

    def __init__(self, name="", **kwargs):
        super().__init__(name=name, **kwargs)
        """
        Keys: name
        """
        #TODO: Add data members
        #TODO: Add triggers! Implement.

        pass
    
    def repr_map(self):
        """Map to use as representation (to create your self).
        Override or extend this for each child!"""

        res = super().repr_map()
        res.update( { 
            
            } )
        return res


    pass
